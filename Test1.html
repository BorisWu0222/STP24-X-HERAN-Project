<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STP24 X ç¦¾è¯å®¶é›» å°ˆæ¡ˆæˆæœDemo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .upload-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .upload-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .upload-group {
            flex: 1;
        }
        
        .upload-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #34495e;
        }
        
        .file-input {
            width: 100%;
            padding: 12px;
            border: 2px dashed #3498db;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-input:hover {
            border-color: #2980b9;
            background: #e3f2fd;
        }
        
        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .controls-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #3498db;
        }
        
        .section-header h2 {
            color: #2c3e50;
            font-size: 1.8em;
            margin: 0;
        }
        
        .current-weights {
            display: flex;
            gap: 20px;
        }
        
        .weight-display {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .formula-display {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .formula-display h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .formula-text {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            color: #495057;
            overflow-x: auto;
        }
        
        .bonus-rules {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        
        .rule-step {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .rule-step:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .rule-step strong {
            color: #2c3e50;
            font-size: 1.1em;
            display: block;
            margin-bottom: 10px;
        }
        
        .rule-step ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .rule-step li {
            margin-bottom: 5px;
            color: #495057;
        }
        
        .rule-step p {
            margin: 8px 0;
            color: #495057;
        }
        
        .rule-step span {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .control-group h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .sub-weights {
            margin-left: 20px;
            padding-left: 20px;
            border-left: 3px solid #ecf0f1;
        }
        
        .slider-group {
            margin-bottom: 20px;
        }
        
        .slider-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #34495e;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
        
        .slider-value {
            min-width: 60px;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #34495e;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .input-row {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        
        .dashboard-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ecf0f1;
        }
        
        .dashboard-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .dashboard-label {
            color: #2c3e50;
        }
        
        .dashboard-value {
            color: #e74c3c;
            font-size: 1.2em;
        }
        
        .dashboard-chart {
            margin-top: 15px;
            width: 100%;
            max-width: 100%;
            height: 180px;
            overflow-x: auto;
        }
        
        .weight-warning {
            color: #e74c3c;
            font-weight: bold;
            margin-top: 20px;
            padding: 15px;
            background: #ffeaa7;
            border-radius: 8px;
            border: 1px solid #fdcb6e;
            text-align: center;
        }
        
        .results-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .summary-card h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        
        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
            max-width: 100%;
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            min-width: 0;
            max-width: 100%;
            height: 350px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .chart-card canvas {
            width: 100% !important;
            height: 260px !important;
            max-width: 100%;
            max-height: 260px;
            display: block;
            margin: 0 auto;
        }

        /* é™åˆ¶ bonusStackChart çš„æœ€å¤§é«˜åº¦ */
        #bonusStackChart {
            width: 100% !important;
            height: 150px !important;
            max-width: 100%;
            max-height: 150px;
            display: block;
            margin: 0 auto;
        }
        
        .chart-card h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin: 30px auto;
            max-width: 1400px;
        }
        
        .table-container h3 {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            margin: 0;
            text-align: center;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .grade-s { color: #e74c3c; font-weight: bold; }
        .grade-a { color: #f39c12; font-weight: bold; }
        .grade-b { color: #3498db; font-weight: bold; }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>STP24 X ç¦¾è¯å®¶é›» å°ˆæ¡ˆæˆæœDemo</h1>
            <p>å¾æ•¸æ“šåˆ°åƒ¹å€¼ï¼šAI é©…å‹•çš„æ™ºèƒ½ KPI æ´å¯Ÿ</p>
        </div>
        
        <div class="upload-section">
            <h2>ğŸ“ æª”æ¡ˆä¸Šå‚³</h2>
            <div class="upload-row">
                <div class="upload-group">
                    <label for="salesFile">éŠ·å”®å–®æ“šæª”æ¡ˆ (Excel)</label>
                    <input type="file" id="salesFile" class="file-input" accept=".xlsx,.xls" />
                </div>
                <div class="upload-group">
                    <label for="kpiFile">æ¥­å‹™å“¡KPIç›®æ¨™æª”æ¡ˆ (Excel)</label>
                    <input type="file" id="kpiFile" class="file-input" accept=".xlsx,.xls" />
                </div>
            </div>
            <button class="btn" id="processBtn">ğŸš€ é–‹å§‹åˆ†æ</button>
        </div>
        
        <div class="controls-section">
            <div class="section-header">
                <h2>ğŸ“Š KPIæ¬Šé‡èª¿æ•´</h2>
                <div class="current-weights">
                    <span class="weight-display">ç­–ç•¥å‹: <strong id="headerStrategyWeight">30%</strong></span>
                    <span class="weight-display">ç‡Ÿé‹å‹: <strong id="headerOperationWeight">70%</strong></span>
                </div>
            </div>
            
            <div class="formula-display">
                <h4>ğŸ“ ç•¶å‰KPIè¨ˆç®—å…¬å¼ï¼š</h4>
                <div class="formula-text" id="kpiFormula">
                    (Aç”¢å“éŠ·å”®é¡æ¯”ä¾‹é”æˆç‡ Ã— 45% + Aç”¢å“å®¢æˆ¶æ•¸é”æˆç‡ Ã— 55%) Ã— 30% + (éŠ·å”®é¡é”æˆç‡ Ã— 30% + æ¯›åˆ©ç‡é”æˆç‡ Ã— 35% + æ–°å®¢æˆ¶ç‡Ÿæ”¶å æ¯”é”æˆç‡ Ã— 20% + å®¢æˆ¶æœå‹™æ»¿æ„åº¦é”æˆç‡ Ã— 15%) Ã— 70%
                </div>
            </div>
            
            <div class="controls-grid">
                <div class="control-group">
                    <h3>ğŸ“Š ç­–ç•¥å‹KPIæ¬Šé‡èª¿æ•´</h3>
                    <div class="slider-group">
                        <label>ç­–ç•¥å‹KPIæ¬Šé‡</label>
                        <div class="slider-container">
                            <input type="range" class="slider" id="strategyWeight" min="0" max="100" value="30">
                            <span class="slider-value" id="strategyWeightValue">30%</span>
                        </div>
                    </div>
                    <div class="sub-weights">
                        <div class="slider-group">
                            <label>Aç”¢å“éŠ·å”®é¡æ¯”ä¾‹</label>
                            <div class="slider-container">
                                <input type="range" class="slider" id="aProductRatioWeight" min="0" max="100" value="45">
                                <span class="slider-value" id="aProductRatioWeightValue">45%</span>
                            </div>
                        </div>
                        <div class="slider-group">
                            <label>Aç”¢å“å®¢æˆ¶æ•¸</label>
                            <div class="slider-container">
                                <input type="range" class="slider" id="aProductCustomersWeight" min="0" max="100" value="55">
                                <span class="slider-value" id="aProductCustomersWeightValue">55%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>ğŸ“ˆ ç‡Ÿé‹å‹KPIæ¬Šé‡èª¿æ•´</h3>
                    <div class="slider-group">
                        <label>ç‡Ÿé‹å‹KPIæ¬Šé‡</label>
                        <div class="slider-container">
                            <input type="range" class="slider" id="operationWeight" min="0" max="100" value="70">
                            <span class="slider-value" id="operationWeightValue">70%</span>
                        </div>
                    </div>
                    <div class="sub-weights">
                        <div class="slider-group">
                            <label>éŠ·å”®é¡é”æˆç‡</label>
                            <div class="slider-container">
                                <input type="range" class="slider" id="salesWeight" min="0" max="100" value="30">
                                <span class="slider-value" id="salesWeightValue">30%</span>
                            </div>
                        </div>
                        <div class="slider-group">
                            <label>æ¯›åˆ©ç‡é”æˆç‡</label>
                            <div class="slider-container">
                                <input type="range" class="slider" id="profitWeight" min="0" max="100" value="35">
                                <span class="slider-value" id="profitWeightValue">35%</span>
                            </div>
                        </div>
                        <div class="slider-group">
                            <label>æ–°å®¢æˆ¶ç‡Ÿæ”¶å æ¯”</label>
                            <div class="slider-container">
                                <input type="range" class="slider" id="newCustomerWeight" min="0" max="100" value="20">
                                <span class="slider-value" id="newCustomerWeightValue">20%</span>
                            </div>
                        </div>
                        <div class="slider-group">
                            <label>å®¢æˆ¶æœå‹™æ»¿æ„åº¦</label>
                            <div class="slider-container">
                                <input type="range" class="slider" id="satisfactionWeight" min="0" max="100" value="15">
                                <span class="slider-value" id="satisfactionWeightValue">15%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="weight-warning" id="weightWarning" style="display: none;">
                âš ï¸ ç¸½æ¬Šé‡ä¸ç­‰æ–¼100%ï¼Œè«‹èª¿æ•´ï¼
            </div>
        </div>
        
        <div class="controls-section">
            <div class="section-header">
                <h2>ğŸ’° çé‡‘è¨­å®š</h2>
                <div class="current-weights">
                    <span class="weight-display">ç¸½é ç®—: <strong id="headerTotalBudget">$5,000,000</strong></span>
                    <span class="weight-display">å€‹äººä¸Šé™: <strong id="headerMaxBonus">$200,000</strong></span>
                </div>
            </div>
            
            <div class="formula-display">
                <h4>ğŸ’° çé‡‘è¨ˆç®—è¦å‰‡ï¼š</h4>
                <div class="bonus-rules">
                    <div class="rule-step">
                        <strong>ç¬¬ä¸€é—œï¼šæœ€ä½é–€æª»</strong>
                        <ul>
                            <li>Aç”¢å“éŠ·å”®é¡æ¯”ä¾‹ â‰¥ 10%ï¼Œå¦å‰‡çé‡‘æ­¸é›¶</li>
                            <li>å®¢æˆ¶æœå‹™æ»¿æ„åº¦ â‰¥ 70%ï¼Œå¦å‰‡æ‰£é™¤10%çé‡‘</li>
                        </ul>
                    </div>
                    
                    <div class="rule-step">
                        <strong>ç¬¬äºŒé—œï¼šåˆ†ç´šåŸºç¤</strong>
                        <div class="bonus-table">
                            <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">ç­‰ç¬¬çµ„åˆ</th>
                                        <th style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">èªªæ˜</th>
                                        <th style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">æ¬Šé‡</th>
                                        <th style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">åŸºç¤çé‡‘</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">SS</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6;">é ‚å°–è¡¨ç¾è€…ï¼šç­–ç•¥å‹70+ ä¸” ç‡Ÿé‹å‹70+</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">10.0</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;"><span id="bonusS" style="color:#e74c3c; font-weight:bold;">$100,000</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">SA/AS</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6;">å„ªç§€è¡¨ç¾è€…ï¼šç­–ç•¥å‹70+, ç‡Ÿé‹å‹40-70 æˆ–ç›¸å</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">6.0</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;"><span id="bonusSA" style="color:#e74c3c; font-weight:bold;">$75,000</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">SB/BS</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6;">åç§‘è¡¨ç¾è€…ï¼šç­–ç•¥å‹70+, ç‡Ÿé‹å‹â‰¤40 æˆ–ç›¸å</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">4.5</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;"><span style="color:#e74c3c; font-weight:bold;">$60,000</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">AA</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6;">ç©©å®šè¡¨ç¾è€…ï¼šç­–ç•¥å‹40-70 ä¸” ç‡Ÿé‹å‹40-70</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">3.0</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;"><span id="bonusAA" style="color:#e74c3c; font-weight:bold;">$60,000</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">AB/BA</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6;">ä¸€èˆ¬è¡¨ç¾è€…ï¼šç­–ç•¥å‹40-70, ç‡Ÿé‹å‹â‰¤40 æˆ–ç›¸å</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">1.8</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;"><span id="bonusOther" style="color:#e74c3c; font-weight:bold;">$40,000</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-weight: bold;">BB</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6;">å¾…æ”¹é€²è€…ï¼šç­–ç•¥å‹â‰¤40 ä¸” ç‡Ÿé‹å‹â‰¤40</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">1.0</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;"><span id="bonusB" style="color:#e74c3c; font-weight:bold;">$20,000</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="rule-step">
                        <strong>ç¬¬ä¸‰é—œï¼šå€‹äººBonus (å¦‚æœç‡Ÿé‹å‹KPIè¶…é100)</strong>
                        <p style="margin: 10px 0; font-weight: bold;">(å¯¦éš›éŠ·å”®é¡ - ç›®æ¨™éŠ·å”®é¡) Ã— å¹³å‡æ¯›åˆ©ç‡ Ã— åˆ†æˆç‡ (è¶…é100è¶Šå¤šåˆ†æˆç‡è¶Šé«˜)</p>
                        
                        <div class="bonus-table">
                            <table style="width: 60%; border-collapse: collapse; margin: 15px 0;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">ç‡Ÿé‹å‹KPIåˆ†æ•¸</th>
                                        <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">åˆ†æˆç‡</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">100 < x â‰¤ 120</td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center; color:#e74c3c; font-weight:bold;">15%</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">120 < x â‰¤ 130</td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center; color:#e74c3c; font-weight:bold;">20%</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">130 < x â‰¤ 140</td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center; color:#e74c3c; font-weight:bold;">28%</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p style="margin: 10px 0; color: #666;">åˆ†æˆç‡éš¨è¶…é¡åˆ†æ•¸æŒ‡æ•¸å¢é•·ï¼Œå—å€‹äººä¸Šé™ <span id="maxBonusDisplay">$200,000</span> é™åˆ¶</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="controls-grid">
                <div class="control-group">
                    <h3>ğŸ’° çé‡‘é ç®—è¨­å®š</h3>
                    <div class="input-row">
                        <div class="input-group" style="flex: 1; margin-right: 20px;">
                            <label>ç¸½çé‡‘é ç®— (å…ƒ)</label>
                            <input type="number" id="totalBudget" value="5000000">
                        </div>
                        <div class="input-group" style="flex: 1;">
                            <label>å€‹äººçé‡‘ä¸Šé™ (å…ƒ)</label>
                            <input type="number" id="maxBonus" value="200000">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <h3>ğŸ“Š çé‡‘å„€è¡¨æ¿</h3>
                <div class="dashboard-summary">
                    <div class="dashboard-item">
                        <span class="dashboard-label">é ä¼°å¯¦éš›ç™¼å‡ºçé‡‘:</span>
                        <span class="dashboard-value" id="dashboardEstimatedPayout">$0</span>
                    </div>
                    <div class="dashboard-chart">
                        <canvas id="bonusStackChart" style="height: 150px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="results-section hidden" id="resultsSection">
            <h2>ğŸ“ˆ åˆ†æçµæœ</h2>
            
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>ç¸½çé‡‘é ç®—</h3>
                    <div class="value" id="totalBudgetDisplay">$5,000,000</div>
                </div>
                <div class="summary-card">
                    <h3>é ä¼°ç™¼æ”¾é‡‘é¡</h3>
                    <div class="value" id="estimatedPayout">$0</div>
                </div>
                <div class="summary-card">
                    <h3>åƒèˆ‡äººæ•¸</h3>
                    <div class="value" id="totalEmployees">0</div>
                </div>
                <div class="summary-card">
                    <h3>å¹³å‡çé‡‘</h3>
                    <div class="value" id="avgBonus">$0</div>
                </div>
            </div>
            
            <div class="charts-container">
                <div class="chart-card">
                    <h3>çé‡‘åˆ†ç´šåˆ†å¸ƒ</h3>
                    <canvas id="gradeChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>çé‡‘é‡‘é¡åˆ†å¸ƒ</h3>
                    <canvas id="bonusChart"></canvas>
                </div>
            </div>
        </div>
        
    </div>

    <div class="table-container hidden" id="bonusTableSection">
        <h3>å€‹äººçé‡‘æ˜ç´°</h3>
        <table id="bonusTable">
            <thead>
                <tr>
                    <th>æ¥­å‹™å“¡</th>
                    <th>ç­–ç•¥å‹è©•åˆ†</th>
                    <th>ç‡Ÿé‹å‹è©•åˆ†</th>
                    <th>ç¸½è©•åˆ†</th>
                    <th>ç­‰ç´š</th>
                    <th>åŸºç¤çé‡‘</th>
                    <th>ç¸¾æ•ˆçé‡‘</th>
                    <th>ç¸½çé‡‘</th>
                </tr>
            </thead>
            <tbody id="bonusTableBody">
            </tbody>
        </table>
    </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let salesData = null;
        let kpiData = null;
        let bonusResults = [];
        let gradeChart = null;
        let bonusChart = null;
        let bonusStackChart = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é é¢è¼‰å…¥å®Œæˆ');
            
            // ç¶å®šäº‹ä»¶
            document.getElementById('processBtn').addEventListener('click', processFiles);
            
            // ç¶å®šæ»‘æ¡¿äº‹ä»¶
            document.getElementById('strategyWeight').addEventListener('input', function() { updateWeights('strategy'); });
            document.getElementById('operationWeight').addEventListener('input', function() { updateWeights('operation'); });
            document.getElementById('aProductRatioWeight').addEventListener('input', function() { updateSubWeights('strategy'); });
            document.getElementById('aProductCustomersWeight').addEventListener('input', function() { updateSubWeights('strategy'); });
            document.getElementById('salesWeight').addEventListener('input', function() { updateSubWeights('operation'); });
            document.getElementById('profitWeight').addEventListener('input', function() { updateSubWeights('operation'); });
            document.getElementById('newCustomerWeight').addEventListener('input', function() { updateSubWeights('operation'); });
            document.getElementById('satisfactionWeight').addEventListener('input', function() { updateSubWeights('operation'); });
            
            // ç¶å®šè¼¸å…¥æ¡†äº‹ä»¶
            document.getElementById('totalBudget').addEventListener('input', updateBonus);
            document.getElementById('maxBonus').addEventListener('input', updateBonus);
            
            // åˆå§‹åŒ–é¡¯ç¤º
            updateWeightSummary();
            updateKPIFormula();
            updateBonusRules();
            updateBonusDashboard();
        });

        // æª”æ¡ˆè™•ç†
        async function processFiles() {
            console.log('é–‹å§‹è™•ç†æª”æ¡ˆ');
            
            const salesFile = document.getElementById('salesFile').files[0];
            const kpiFile = document.getElementById('kpiFile').files[0];
            
            if (!salesFile || !kpiFile) {
                alert('è«‹é¸æ“‡å…©å€‹æª”æ¡ˆ');
                return;
            }
            
            try {
                document.getElementById('processBtn').textContent = 'è™•ç†ä¸­...';
                document.getElementById('processBtn').disabled = true;
                
                console.log('è®€å–éŠ·å”®æª”æ¡ˆ...');
                salesData = await readExcel(salesFile);
                console.log('éŠ·å”®æ•¸æ“š:', salesData.length, 'ç­†è¨˜éŒ„');
                
                console.log('è®€å–KPIæª”æ¡ˆ...');
                kpiData = await readExcel(kpiFile);
                console.log('KPIæ•¸æ“š:', kpiData.length, 'ç­†è¨˜éŒ„');
                
                console.log('é–‹å§‹è¨ˆç®—çé‡‘...');
                calculateBonus();
                displayResults();
                
                document.getElementById('processBtn').textContent = 'âœ… åˆ†æå®Œæˆ';
                console.log('è™•ç†å®Œæˆï¼');
                
            } catch (error) {
                console.error('æª”æ¡ˆè™•ç†éŒ¯èª¤:', error);
                alert('æª”æ¡ˆè™•ç†å¤±æ•—: ' + error.message);
                document.getElementById('processBtn').textContent = 'ğŸš€ é–‹å§‹åˆ†æ';
                document.getElementById('processBtn').disabled = false;
            }
        }

        // è®€å–Excelæª”æ¡ˆ
        function readExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(new Error('ç„¡æ³•è®€å–Excelæª”æ¡ˆ: ' + error.message));
                    }
                };
                reader.onerror = function() {
                    reject(new Error('æª”æ¡ˆè®€å–å¤±æ•—'));
                };
                reader.readAsBinaryString(file);
            });
        }

        // è¨ˆç®—çé‡‘
        function calculateBonus() {
            if (!salesData || !kpiData) {
                console.error('ç¼ºå°‘å¿…è¦çš„æ•¸æ“š');
                return;
            }
            
            bonusResults = [];
            
            kpiData.forEach((employee, index) => {
                const employeeCode = employee['æ¥­å‹™å“¡ç·¨è™Ÿ'] || employee['å“¡å·¥ç·¨è™Ÿ'] || employee['ç·¨è™Ÿ'];
                const employeeName = employee['æ¥­å‹™å“¡å§“å'] || employee['å§“å'] || employee['å“¡å·¥å§“å'];
                
                if (!employeeCode) {
                    console.warn('ç¬¬', index + 1, 'ç­†è¨˜éŒ„ç¼ºå°‘å“¡å·¥ç·¨è™Ÿ');
                    return;
                }
                
                const actualKPI = calculateActualKPI(employeeCode);
                const achievementRates = calculateAchievementRates(employee, actualKPI);
                const scores = calculateFinalScores(achievementRates);
                const bonus = calculateEmployeeBonus(scores, actualKPI, employee);
                
                bonusResults.push({
                    code: employeeCode,
                    name: employeeName || employeeCode,
                    strategyScore: scores.strategy,
                    operationScore: scores.operation,
                    totalScore: scores.total,
                    grade: bonus.grade,
                    baseBonus: bonus.base,
                    performanceBonus: bonus.performance,
                    totalBonus: bonus.total
                });
            });
            
            console.log('è¨ˆç®—å®Œæˆï¼Œå…±è™•ç†:', bonusResults.length, 'ç­†è¨˜éŒ„');
            adjustBonusForBudget();
        }

        // è¨ˆç®—å¯¦éš›KPIå€¼
        function calculateActualKPI(employeeCode) {
            const employeeSales = salesData.filter(record => {
                const recordCode = record['æ¥­å‹™å“¡ç·¨è™Ÿ'] || record['å“¡å·¥ç·¨è™Ÿ'] || record['ç·¨è™Ÿ'];
                return recordCode === employeeCode;
            });
            
            if (employeeSales.length === 0) {
                return {
                    aProductRatio: Math.random() * 20,
                    aProductCustomers: Math.floor(Math.random() * 50),
                    totalSales: Math.random() * 1000000,
                    avgProfitMargin: Math.random() * 30,
                    newCustomerRatio: Math.random() * 15,
                    satisfaction: 70 + Math.random() * 25
                };
            }
            
            const totalSales = employeeSales.reduce((sum, record) => {
                const sales = parseFloat(record['éŠ·å”®é‡‘é¡'] || record['éŠ·å”®é¡'] || record['é‡‘é¡'] || 0);
                return sum + sales;
            }, 0);
            
            const aProductSales = employeeSales
                .filter(record => {
                    const productCode = record['éŠ·è²¨å“è™Ÿ'] || record['ç”¢å“ç·¨è™Ÿ'] || '';
                    return productCode === '00E300076-00';
                })
                .reduce((sum, record) => {
                    const sales = parseFloat(record['éŠ·å”®é‡‘é¡'] || record['éŠ·å”®é¡'] || record['é‡‘é¡'] || 0);
                    return sum + sales;
                }, 0);
            
            const aProductCustomers = new Set(
                employeeSales
                    .filter(record => {
                        const productCode = record['éŠ·è²¨å“è™Ÿ'] || record['ç”¢å“ç·¨è™Ÿ'] || '';
                        return productCode === '00E300076-00';
                    })
                    .map(record => record['å®¢æˆ¶ä»£è™Ÿ'] || record['å®¢æˆ¶'])
            ).size;
            
            const totalProfit = employeeSales.reduce((sum, record) => {
                const profit = parseFloat(record['éŠ·è²¨æ¯›åˆ©'] || record['æ¯›åˆ©'] || 0);
                const sales = parseFloat(record['éŠ·å”®é‡‘é¡'] || record['éŠ·å”®é¡'] || record['é‡‘é¡'] || 0);
                return sum + (profit * sales);
            }, 0);
            
            const avgProfitMargin = totalSales > 0 ? (totalProfit / totalSales) * 100 : 0;
            
            return {
                aProductRatio: totalSales > 0 ? (aProductSales / totalSales) * 100 : 0,
                aProductCustomers: aProductCustomers,
                totalSales: totalSales,
                avgProfitMargin: avgProfitMargin,
                newCustomerRatio: Math.random() * 20,
                satisfaction: 75 + Math.random() * 20
            };
        }

        // è¨ˆç®—é”æˆç‡
        function calculateAchievementRates(employee, actualKPI) {
            const targets = {
                aProductRatio: parseFloat((employee['Aç”¢å“ä½”ç¸½éŠ·å”®é¡çš„æ¯”ä¾‹'] || '20%').replace('%', '')),
                aProductCustomers: parseInt(employee['è³¼è²·Aç”¢å“çš„å®¢æˆ¶æ•¸'] || '20'),
                totalSales: parseFloat(employee['ç¸½éŠ·å”®é¡'] || '500000'),
                avgProfitMargin: parseFloat((employee['å¹³å‡æ¯›åˆ©ç‡'] || '15%').replace('%', '')),
                newCustomerRatio: parseFloat((employee['æ–°å®¢æˆ·ç‡Ÿæ”¶å æ¯”'] || '10%').replace('%', '')),
                satisfaction: parseFloat((employee['å®¢æˆ¶æœå‹™æ»¿æ„åº¦'] || '80%').replace('%', ''))
            };
            
            return {
                aProductRatio: targets.aProductRatio > 0 ? (actualKPI.aProductRatio / targets.aProductRatio) * 100 : 0,
                aProductCustomers: targets.aProductCustomers > 0 ? (actualKPI.aProductCustomers / targets.aProductCustomers) * 100 : 0,
                totalSales: targets.totalSales > 0 ? (actualKPI.totalSales / targets.totalSales) * 100 : 0,
                avgProfitMargin: targets.avgProfitMargin > 0 ? (actualKPI.avgProfitMargin / targets.avgProfitMargin) * 100 : 0,
                newCustomerRatio: targets.newCustomerRatio > 0 ? (actualKPI.newCustomerRatio / targets.newCustomerRatio) * 100 : 0,
                satisfaction: targets.satisfaction > 0 ? (actualKPI.satisfaction / targets.satisfaction) * 100 : 0
            };
        }

        // è¨ˆç®—æœ€çµ‚åˆ†æ•¸
        function calculateFinalScores(rates) {
            const strategyWeight = parseFloat(document.getElementById('strategyWeight').value) / 100;
            const operationWeight = parseFloat(document.getElementById('operationWeight').value) / 100;
            
            const aProductRatioWeight = parseFloat(document.getElementById('aProductRatioWeight').value) / 100;
            const aProductCustomersWeight = parseFloat(document.getElementById('aProductCustomersWeight').value) / 100;
            
            const salesWeight = parseFloat(document.getElementById('salesWeight').value) / 100;
            const profitWeight = parseFloat(document.getElementById('profitWeight').value) / 100;
            const newCustomerWeight = parseFloat(document.getElementById('newCustomerWeight').value) / 100;
            const satisfactionWeight = parseFloat(document.getElementById('satisfactionWeight').value) / 100;
            
            const strategyScore = (rates.aProductRatio * aProductRatioWeight + rates.aProductCustomers * aProductCustomersWeight);
            const operationScore = (rates.totalSales * salesWeight + rates.avgProfitMargin * profitWeight + rates.newCustomerRatio * newCustomerWeight + rates.satisfaction * satisfactionWeight);
            const totalScore = strategyScore * strategyWeight + operationScore * operationWeight;
            
            return {
                strategy: strategyScore,
                operation: operationScore,
                total: totalScore
            };
        }

        // è¨ˆç®—å€‹äººçé‡‘
        function calculateEmployeeBonus(scores, actualKPI, employee) {
            if (actualKPI.aProductRatio < 10) {
                return { grade: 'FAIL', base: 0, performance: 0, total: 0 };
            }
            
            let penaltyRate = actualKPI.satisfaction < 70 ? 0.9 : 1;
            
            const getGrade = (score) => {
                if (score <= 40) return 'B';
                if (score <= 70) return 'A';
                return 'S';
            };
            
            const strategyGrade = getGrade(scores.strategy);
            const operationGrade = getGrade(scores.operation);
            const combinedGrade = strategyGrade + operationGrade;
            
            const baseAmounts = getDefaultBaseAmounts();
            const baseBonus = baseAmounts[combinedGrade] || 0;
            
            let performanceBonus = 0;
            if (scores.operation > 100) {
                const operationScore = scores.operation;
                let shareRate = 0;
                
                if (operationScore > 100 && operationScore <= 120) {
                    shareRate = 0.15;
                } else if (operationScore > 120 && operationScore <= 130) {
                    shareRate = 0.20;
                } else if (operationScore > 130 && operationScore <= 140) {
                    shareRate = 0.28;
                } else if (operationScore > 140) {
                    const excess = operationScore - 140;
                    shareRate = 0.28 + (excess / 100) * 0.1;
                    shareRate = Math.min(shareRate, 0.5);
                }
                
                const targetSales = parseFloat(employee['ç¸½éŠ·å”®é¡'] || 200000);
                const excessSales = Math.max(0, actualKPI.totalSales - targetSales);
                performanceBonus = excessSales * (actualKPI.avgProfitMargin / 100) * shareRate;
            }
            
            const totalBonus = (baseBonus + performanceBonus) * penaltyRate;
            
            return {
                grade: combinedGrade,
                base: baseBonus * penaltyRate,
                performance: performanceBonus * penaltyRate,
                total: totalBonus
            };
        }

        // ç²å–é è¨­åŸºç¤çé‡‘
        function getDefaultBaseAmounts() {
            return calculateDynamicBaseBonus();
        }

        // å‹•æ…‹è¨ˆç®—åŸºç¤çé‡‘åˆ†é…
        function calculateDynamicBaseBonus() {
            const totalBudget = parseFloat(document.getElementById('totalBudget').value);
            
            let gradeDistribution = {};
            
            if (bonusResults.length > 0) {
                bonusResults.forEach(result => {
                    if (result.grade !== 'FAIL') {
                        gradeDistribution[result.grade] = (gradeDistribution[result.grade] || 0) + 1;
                    }
                });
            } else {
                gradeDistribution = getHistoricalGradeDistribution(10);
            }
            
            const gradeWeights = getStepUpWeights();
            
            let totalWeight = 0;
            Object.entries(gradeDistribution).forEach(([grade, count]) => {
                totalWeight += (gradeWeights[grade] || 1) * count;
            });
            
            const baseAmounts = {};
            const perWeightAmount = totalWeight > 0 ? totalBudget / totalWeight : 0;
            
            Object.keys(gradeWeights).forEach(grade => {
                baseAmounts[grade] = (gradeWeights[grade] || 1) * perWeightAmount;
            });
            
            return baseAmounts;
        }

        // æ ¹æ“šæ­·å²æ•¸æ“šä¼°ç®—ç­‰ç´šåˆ†å¸ƒ
        function getHistoricalGradeDistribution(totalEmployees) {
            const distributionRatios = {
                'SS': 0.05, 'SA': 0.10, 'SB': 0.05, 'AS': 0.10, 'AA': 0.25,
                'AB': 0.25, 'BA': 0.10, 'BS': 0.05, 'BB': 0.05
            };
            
            const estimatedDistribution = {};
            Object.entries(distributionRatios).forEach(([grade, ratio]) => {
                estimatedDistribution[grade] = Math.max(1, Math.round(totalEmployees * ratio));
            });
            
            return estimatedDistribution;
        }

        // éšæ¢¯å‘ä¸Šçš„æ¬Šé‡è¨­è¨ˆ
        function getStepUpWeights() {
            return {
                'SS': 10.0, 'SA': 6.0, 'SB': 4.5, 'AS': 6.0, 'AA': 3.0,
                'AB': 1.8, 'BA': 1.8, 'BS': 1.5, 'BB': 1.0, 'FAIL': 0
            };
        }

        // èª¿æ•´çé‡‘ä»¥ç¬¦åˆé ç®—
        function adjustBonusForBudget() {
            const totalBudget = parseFloat(document.getElementById('totalBudget').value);
            const maxBonus = parseFloat(document.getElementById('maxBonus').value);
            
            const dynamicBaseAmounts = calculateDynamicBaseBonus();
            
            bonusResults.forEach(result => {
                if (result.grade !== 'FAIL') {
                    const newBaseBonus = dynamicBaseAmounts[result.grade] || 0;
                    const currentPenaltyRate = result.baseBonus > 0 ? 
                        (result.baseBonus / getDefaultBaseAmounts()[result.grade]) : 0.9;
                    
                    result.baseBonus = newBaseBonus * Math.min(currentPenaltyRate || 0.9, 1);
                    result.totalBonus = result.baseBonus + result.performanceBonus;
                }
            });
            
            const currentTotal = bonusResults.reduce((sum, result) => sum + result.totalBonus, 0);
            
            if (currentTotal > totalBudget && bonusResults.length > 0) {
                const finalAdjustmentRatio = totalBudget / currentTotal;
                
                bonusResults.forEach(result => {
                    result.baseBonus *= finalAdjustmentRatio;
                    result.performanceBonus *= finalAdjustmentRatio;
                    result.totalBonus *= finalAdjustmentRatio;
                    
                    if (result.totalBonus > maxBonus) {
                        const excess = result.totalBonus - maxBonus;
                        result.totalBonus = maxBonus;
                        result.performanceBonus = Math.max(0, result.performanceBonus - excess);
                    }
                });
            }
        }

        // é¡¯ç¤ºçµæœ
        function displayResults() {
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('bonusTableSection').classList.remove('hidden');
            updateSummaryCards();
            updateCharts();
            updateTable();
            updateBonusDashboard();
        }

        // æ›´æ–°æ‘˜è¦å¡ç‰‡
        function updateSummaryCards() {
            const totalBudget = parseFloat(document.getElementById('totalBudget').value);
            const estimatedPayout = bonusResults.reduce((sum, result) => sum + result.totalBonus, 0);
            const totalEmployees = bonusResults.length;
            const avgBonus = totalEmployees > 0 ? estimatedPayout / totalEmployees : 0;
            
            document.getElementById('totalBudgetDisplay').textContent = '$' + totalBudget.toLocaleString();
            document.getElementById('estimatedPayout').textContent = '$' + Math.round(estimatedPayout).toLocaleString();
            document.getElementById('totalEmployees').textContent = totalEmployees;
            document.getElementById('avgBonus').textContent = '$' + Math.round(avgBonus).toLocaleString();
        }

        // æ›´æ–°åœ–è¡¨
        function updateCharts() {
            updateGradeChart();
            updateBonusChart();
        }

        // æ›´æ–°ç­‰ç´šåˆ†å¸ƒåœ–
        function updateGradeChart() {
            // å®šç¾©ä¸ƒç¨®åˆ†ç´š
            const gradeLabels = ['2S', '2A', '2B', 'SA', 'SB', 'AB', 'FAIL'];
            const gradeColors = {
                '2S': '#e74c3c',    // ç´…
                '2A': '#f39c12',    // æ©™
                '2B': '#3498db',    // è—
                'SA': '#2ecc71',    // ç¶ 
                'SB': '#9b59b6',    // ç´«
                'AB': '#1abc9c',    // é’
                'FAIL': '#7f8c8d'   // ç°
            };

            // çµ±è¨ˆåˆ†ç´šäººæ•¸
            const gradeCount = {
                '2S': 0,
                '2A': 0,
                '2B': 0,
                'SA': 0,
                'SB': 0,
                'AB': 0,
                'FAIL': 0
            };

            // ä¾æ“šå€‹äººç­‰ç´šåˆ†é¡
            bonusResults.forEach(result => {
                let g = result.grade;
                if (g === 'FAIL') {
                    gradeCount['FAIL']++;
                } else {
                    // è½‰æ›æˆä¸ƒå¤§é¡
                    // 2S: SS, 2A: AA, 2B: BB, SA: SA/AS, SB: SB/BS, AB: AB/BA
                    if (g === 'SS') gradeCount['2S']++;
                    else if (g === 'AA') gradeCount['2A']++;
                    else if (g === 'BB') gradeCount['2B']++;
                    else if (g === 'SA' || g === 'AS') gradeCount['SA']++;
                    else if (g === 'SB' || g === 'BS') gradeCount['SB']++;
                    else if (g === 'AB' || g === 'BA') gradeCount['AB']++;
                }
            });

            const ctx = document.getElementById('gradeChart').getContext('2d');
            if (gradeChart) {
                gradeChart.destroy();
            }
            gradeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: gradeLabels,
                    datasets: [{
                        data: gradeLabels.map(l => gradeCount[l]),
                        backgroundColor: gradeLabels.map(l => gradeColors[l]),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                generateLabels: function(chart) {
                                    // é¡¯ç¤ºäººæ•¸
                                    const data = chart.data;
                                    return data.labels.map((label, i) => {
                                        return {
                                            text: label + ' (' + data.datasets[0].data[i] + 'äºº)',
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            strokeStyle: data.datasets[0].backgroundColor[i],
                                            index: i
                                        };
                                    });
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    return label + ': ' + value + 'äºº';
                                }
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°çé‡‘åˆ†å¸ƒåœ–
        function updateBonusChart() {
            const bonusRanges = {
                '0-50K': 0,
                '50K-100K': 0,
                '100K-150K': 0,
                '150K+': 0
            };
            
            bonusResults.forEach(result => {
                if (result.totalBonus < 50000) bonusRanges['0-50K']++;
                else if (result.totalBonus < 100000) bonusRanges['50K-100K']++;
                else if (result.totalBonus < 150000) bonusRanges['100K-150K']++;
                else bonusRanges['150K+']++;
            });
            
            const ctx = document.getElementById('bonusChart').getContext('2d');
            
            if (bonusChart) {
                bonusChart.destroy();
            }
            
            bonusChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(bonusRanges),
                    datasets: [{
                        label: 'äººæ•¸',
                        data: Object.values(bonusRanges),
                        backgroundColor: 'rgba(52, 152, 219, 0.8)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°è¡¨æ ¼
        function updateTable() {
            const tbody = document.getElementById('bonusTableBody');
            tbody.innerHTML = '';
            
            bonusResults.forEach(result => {
                const row = document.createElement('tr');
                const gradeClass = result.grade.includes('S') ? 'grade-s' : 
                                  result.grade.includes('A') ? 'grade-a' : 'grade-b';
                
                row.innerHTML = `
                    <td>${result.name}</td>
                    <td>${Math.round(result.strategyScore)}</td>
                    <td>${Math.round(result.operationScore)}</td>
                    <td>${Math.round(result.totalScore)}</td>
                    <td class="${gradeClass}">${result.grade}</td>
                    <td>$${Math.round(result.baseBonus).toLocaleString()}</td>
                    <td>$${Math.round(result.performanceBonus).toLocaleString()}</td>
                    <td><strong>$${Math.round(result.totalBonus).toLocaleString()}</strong></td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // æ›´æ–°KPIå…¬å¼é¡¯ç¤º
        function updateKPIFormula() {
            const aProductRatio = document.getElementById('aProductRatioWeight').value;
            const aProductCustomers = document.getElementById('aProductCustomersWeight').value;
            const strategyWeight = document.getElementById('strategyWeight').value;
            const salesWeight = document.getElementById('salesWeight').value;
            const profitWeight = document.getElementById('profitWeight').value;
            const newCustomerWeight = document.getElementById('newCustomerWeight').value;
            const satisfactionWeight = document.getElementById('satisfactionWeight').value;
            const operationWeight = document.getElementById('operationWeight').value;
            
            const formula = `(Aç”¢å“éŠ·å”®é¡æ¯”ä¾‹é”æˆç‡ Ã— ${aProductRatio}% + Aç”¢å“å®¢æˆ¶æ•¸é”æˆç‡ Ã— ${aProductCustomers}%) Ã— ${strategyWeight}% + (éŠ·å”®é¡é”æˆç‡ Ã— ${salesWeight}% + æ¯›åˆ©ç‡é”æˆç‡ Ã— ${profitWeight}% + æ–°å®¢æˆ¶ç‡Ÿæ”¶å æ¯”é”æˆç‡ Ã— ${newCustomerWeight}% + å®¢æˆ¶æœå‹™æ»¿æ„åº¦é”æˆç‡ Ã— ${satisfactionWeight}%) Ã— ${operationWeight}%`;
            
            document.getElementById('kpiFormula').textContent = formula;
        }

        // æ›´æ–°çé‡‘è¦å‰‡é¡¯ç¤º
        function updateBonusRules() {
            const totalBudget = parseFloat(document.getElementById('totalBudget').value);
            const maxBonus = parseFloat(document.getElementById('maxBonus').value);
            const budgetRatio = totalBudget / 5000000;
            
            document.getElementById('bonusS').textContent = '$' + Math.round(100000 * budgetRatio).toLocaleString();
            document.getElementById('bonusSA').textContent = '$' + Math.round(75000 * budgetRatio).toLocaleString();
            document.getElementById('bonusAA').textContent = '$' + Math.round(60000 * budgetRatio).toLocaleString();
            document.getElementById('bonusOther').textContent = '$' + Math.round(40000 * budgetRatio).toLocaleString();
            document.getElementById('bonusB').textContent = '$' + Math.round(20000 * budgetRatio).toLocaleString();
            document.getElementById('maxBonusDisplay').textContent = '$' + maxBonus.toLocaleString();
        }

        // æ¬Šé‡æ›´æ–°å‡½æ•¸
function updateWeights(changed) {
    let strategyWeight = parseFloat(document.getElementById('strategyWeight').value);
    let operationWeight = parseFloat(document.getElementById('operationWeight').value);

    if (changed === 'strategy') {
        // ç•¶ç­–ç•¥å‹è®Šå‹•æ™‚ï¼Œç‡Ÿé‹å‹è‡ªå‹•è£œè¶³
        operationWeight = 100 - strategyWeight;
        document.getElementById('operationWeight').value = operationWeight;
        document.getElementById('operationWeightValue').textContent = operationWeight + '%';
    } else if (changed === 'operation') {
        // ç•¶ç‡Ÿé‹å‹è®Šå‹•æ™‚ï¼Œç­–ç•¥å‹è‡ªå‹•è£œè¶³
        strategyWeight = 100 - operationWeight;
        document.getElementById('strategyWeight').value = strategyWeight;
        document.getElementById('strategyWeightValue').textContent = strategyWeight + '%';
    }

    // æ›´æ–°é¡¯ç¤º
    document.getElementById('strategyWeightValue').textContent = strategyWeight + '%';
    document.getElementById('operationWeightValue').textContent = operationWeight + '%';

    updateWeightSummary();
    updateKPIFormula();

    if (bonusResults.length > 0) {
        calculateBonus();
        displayResults();
    }
}

        // å­æ¬Šé‡æ›´æ–°å‡½æ•¸
        function updateSubWeights(category) {
            if (category === 'strategy') {
                const aProductRatio = parseFloat(document.getElementById('aProductRatioWeight').value);
                const aProductCustomers = parseFloat(document.getElementById('aProductCustomersWeight').value);
                
                if (aProductRatio + aProductCustomers !== 100) {
                    document.getElementById('aProductCustomersWeight').value = 100 - aProductRatio;
                    document.getElementById('aProductCustomersWeightValue').textContent = (100 - aProductRatio) + '%';
                }
                
                document.getElementById('aProductRatioWeightValue').textContent = aProductRatio + '%';
                document.getElementById('aProductCustomersWeightValue').textContent = aProductCustomers + '%';
                
            } else if (category === 'operation') {
                const sales = parseFloat(document.getElementById('salesWeight').value);
                const profit = parseFloat(document.getElementById('profitWeight').value);
                const newCustomer = parseFloat(document.getElementById('newCustomerWeight').value);
                const satisfaction = parseFloat(document.getElementById('satisfactionWeight').value);
                
                document.getElementById('salesWeightValue').textContent = sales + '%';
                document.getElementById('profitWeightValue').textContent = profit + '%';
                document.getElementById('newCustomerWeightValue').textContent = newCustomer + '%';
                document.getElementById('satisfactionWeightValue').textContent = satisfaction + '%';
                
                const total = sales + profit + newCustomer + satisfaction;
                if (total !== 100) {
                    document.getElementById('weightWarning').style.display = 'block';
                    document.getElementById('weightWarning').textContent = `âš ï¸ ç‡Ÿé‹å‹KPIæ¬Šé‡ç¸½å’Œç‚º${total}%ï¼Œè«‹èª¿æ•´ç‚º100%ï¼`;
                } else {
                    document.getElementById('weightWarning').style.display = 'none';
                }
            }
            
            updateWeightSummary();
            updateKPIFormula();
            
            if (bonusResults.length > 0) {
                calculateBonus();
                displayResults();
            }
        }

        // æ›´æ–°æ¬Šé‡ç¸½è¦½
        function updateWeightSummary() {
            const strategyWeight = parseFloat(document.getElementById('strategyWeight').value);
            const operationWeight = parseFloat(document.getElementById('operationWeight').value);
            
            document.getElementById('headerStrategyWeight').textContent = strategyWeight + '%';
            document.getElementById('headerOperationWeight').textContent = operationWeight + '%';
            
            const totalBudget = parseFloat(document.getElementById('totalBudget').value);
            const maxBonus = parseFloat(document.getElementById('maxBonus').value);
            document.getElementById('headerTotalBudget').textContent = '$' + totalBudget.toLocaleString();
            document.getElementById('headerMaxBonus').textContent = '$' + maxBonus.toLocaleString();
        }

        // çé‡‘æ›´æ–°å‡½æ•¸
        function updateBonus() {
            updateWeightSummary();
            updateBonusRules();
            
            if (bonusResults.length > 0) {
                adjustBonusForBudget();
                displayResults();
            }
        }

        // æ›´æ–°çé‡‘å„€è¡¨æ¿
        function updateBonusDashboard() {
            const estimatedPayout = bonusResults.reduce((sum, result) => sum + result.totalBonus, 0);
            document.getElementById('dashboardEstimatedPayout').textContent = '$' + Math.round(estimatedPayout).toLocaleString();
            
            updateBonusStackChart();
        }

        // æ›´æ–°ç´¯ç©å †ç–Šåœ–
        function updateBonusStackChart() {
            if (bonusResults.length === 0) return;
            
            const employeeNames = bonusResults.map(result => result.name || result.code);
            const baseBonus = bonusResults.map(result => result.baseBonus);
            const performanceBonus = bonusResults.map(result => result.performanceBonus);
            
            const ctx = document.getElementById('bonusStackChart').getContext('2d');
            
            if (bonusStackChart) {
                bonusStackChart.destroy();
            }
            
            bonusStackChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: employeeNames,
                    datasets: [
                        {
                            label: 'åŸºç¤çé‡‘',
                            data: baseBonus,
                            backgroundColor: 'rgba(52, 152, 219, 0.8)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'ç¸¾æ•ˆçé‡‘',
                            data: performanceBonus,
                            backgroundColor: 'rgba(231, 76, 60, 0.8)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + Math.round(context.parsed.y).toLocaleString();
                                },
                                footer: function(tooltipItems) {
                                    let total = 0;
                                    tooltipItems.forEach(item => {
                                        total += bonusResults[item.dataIndex].totalBonus;
                                    });
                                    return 'ç¸½çé‡‘: $' + Math.round(total).toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>